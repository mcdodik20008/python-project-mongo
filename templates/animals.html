{% extends "base.html" %}

{% block content %}
<h1>Животные</h1>
<a href="/add-animal/" class="btn btn-primary" style="margin-left: 5%">Добавить животное</a>

<table class="table">
    <thead>
        <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Возраст</th>
            <th>Вид</th>
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for animal in animals %}
        <tr data-id="{{ animal._id }}">
            <td>{{ animal._id }}</td>
            <td contenteditable="false" class="name">{{ animal.name }}</td>
            <td contenteditable="false" class="age">{{ animal.age }}</td>
            <td contenteditable="false" class="species">{{ animal.species }}</td>
            <td>
                <button onclick="toggleEdit(this)" class="btn btn-warning">Редактировать</button>
                <button onclick="deleteAnimal('{{ animal._id }}')" class="btn btn-danger">Удалить</button>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    function toggleEdit(button) {
        const row = button.closest('tr');
        const isEditing = button.innerText === 'Сохранить';

        button.innerText = isEditing ? 'Редактировать' : 'Сохранить';

        button.classList.toggle('btn-warning', isEditing);
        button.classList.toggle('btn-success', !isEditing);

        const editableFields = row.querySelectorAll('.name, .age, .species');
        editableFields.forEach(field => {
            field.contentEditable = !isEditing;
            
            if (isEditing) field.style.backgroundColor = "";
            else field.style.backgroundColor = "#fffdeb";
        });

        if (isEditing) {
            const updatedData = {
                name: row.querySelector('.name').innerText,
                age: parseInt(row.querySelector('.age').innerText),
                species: row.querySelector('.species').innerText,
            };

            saveAnimal(row.getAttribute('data-id'), updatedData);
        }
    }

    async function saveAnimal(id, data) {
        try {
            const response = await fetch(`/update-animal/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            if (!response.ok) throw new Error('Ошибка сохранения');
        } catch (error) {
            console.error(error);
        }
    }

    async function deleteAnimal(id) {
        try {
            const response = await fetch(`/delete-animal/${id}`, { method: 'DELETE' });
            if (!response.ok) throw new Error('Ошибка удаления');
            window.location.replace("http://localhost:8000/");
        } catch (error) {
            console.error(error);
            window.location.replace("http://localhost:8000/");
        }
    }
</script>
{% endblock %}
